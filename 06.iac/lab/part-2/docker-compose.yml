# Docker equivalent of the Vagrant Rocky 8 VM with GitLab (Part 2)
# Uses the official GitLab Docker image instead of installing via Ansible on a VM
# This achieves the same result: a running GitLab instance accessible on port 8888
# Using GitLab CE (Community Edition) to reduce memory footprint

services:
  gitlab_server:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab.server.local
    hostname: gitlab.local
    restart: unless-stopped
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://gitlab.local'
        gitlab_rails['gitlab_shell_ssh_port'] = 2224
        # ---- Memory optimizations (8GB server) ----
        puma['worker_processes'] = 0
        puma['min_threads'] = 1
        puma['max_threads'] = 2
        sidekiq['concurrency'] = 2
        prometheus_monitoring['enable'] = false
        gitlab_kas['enable'] = false
        gitlab_pages['enable'] = false
        registry['enable'] = false
        postgresql['shared_buffers'] = "128MB"
        postgresql['max_worker_processes'] = 2
    ports:
      # Equivalent to: config.vm.network "forwarded_port", guest: 80, host: 8080
      # Using port 8888 because 8080 is occupied by Coolify
      - "8888:80"
      - "2224:22"
    volumes:
      - gitlab_config:/etc/gitlab
      - gitlab_logs:/var/log/gitlab
      - gitlab_data:/var/opt/gitlab
      # Mount playbooks for Ansible provisioning inside the container
      - ./playbooks:/vagrant/playbooks:ro
    deploy:
      resources:
        limits:
          memory: 2560M
          cpus: '2'
    shm_size: '256m'
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost/-/health"]
      interval: 60s
      timeout: 10s
      retries: 15
      start_period: 600s

volumes:
  gitlab_config:
  gitlab_logs:
  gitlab_data:
